{% extends 'base.html' %}
{% load custom_filters %}

{% block title %}Quản lý điểm lớp {{ assignment.classroom.name }} - {{ assignment.subject.name }}{% endblock %}

{% block extra_css %}
<style>
    .edit-indicator {
        position: relative;
        z-index: 100;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .input-group {
        position: relative;
    }
    td {
        position: relative;
    }
    .average-grade {
        background-color: #e9ecef; /* Updated to match dashboard.html */
        font-weight: bold;
    }
    .incomplete-grades {
        color: #ff6b6b; /* Updated to match dashboard.html */
        font-style: italic;
    }
    .alert-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        min-width: 250px;
        max-width: 350px;
    }

    .alert {
        margin-bottom: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        animation: slideIn 0.5s ease-out;
    }

    @keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    .alert.fade-out {
        animation: fadeOut 0.5s ease-out forwards;
    }

    @keyframes fadeOut {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(100%);
            opacity: 0;
        }
    }
</style>
</style>
{% endblock %}

{% block content %}
<div class="alert-container"></div>

<div class="container py-4">
    <div class="card shadow">
        <div class="card-header bg-primary bg-gradient text-white d-flex justify-content-between align-items-center">
            <h4 class="mb-0">
                <i class="fas fa-graduation-cap me-2"></i>Quản lý điểm: {{ assignment.subject.name }} - {{ assignment.classroom.name }}
            </h4>
            <div>
                <a href="{% url 'teacher_dashboard' %}" class="btn btn-outline-light btn-sm">
                    <i class="fas fa-arrow-left me-1"></i>Quay lại
                </a>
                <a href="{% url 'teacher_class_students' assignment.id %}" class="btn btn-outline-light btn-sm ms-1">
                    <i class="fas fa-users me-1"></i>Danh sách SV
                </a>
                <a href="{% url 'manage_grade_types' assignment.id %}" class="btn btn-outline-light btn-sm ms-1">
                    <i class="fas fa-list-alt me-1"></i>Quản lý loại điểm
                </a>
                <a href="{% url 'bulk_update_grades' assignment.id %}" class="btn btn-outline-light btn-sm ms-1">
                    <i class="fas fa-users-cog me-1"></i>Cập nhật hàng loạt
                </a>
                <a href="{% url 'upload_grades' assignment.id %}" class="btn btn-outline-light btn-sm ms-1">
                    <i class="fas fa-file-upload me-1"></i>Tải lên từ Excel
                </a>
            </div>
        </div>
        <div class="card-body">
            {% if messages %}
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            {% endif %}
            
            <div class="mb-4">
                <h5>Thông tin:</h5>
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Lớp:</strong> {{ assignment.classroom.name }}</p>
                        <p><strong>Môn học:</strong> {{ assignment.subject.name }}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Học kỳ:</strong> {{ assignment.semester.name }}</p>
                        <p><strong>Giáo viên:</strong> {{ assignment.teacher.user.get_full_name }}</p>
                    </div>
                </div>
            </div>
            
            {% if students %}
                <div class="table-responsive">
                    <table class="table table-hover table-bordered">
                        <thead class="table-light">
                            <tr>
                                <th>Mã SV</th>
                                <th>Họ tên</th>
                                {% for grade_type in grade_types %}
                                    <th>{{ grade_type.name }}</th>
                                {% endfor %}
                                <th class="average-grade">Điểm TB</th>
                                <th>Thao tác</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for student in students %}
                                <tr data-student-id="{{ student.id }}">
                                    <td>{{ student.student_id }}</td>
                                    <td>{{ student.name }}</td>
                                    {% for grade_type in grade_types %}
                                        <td>
                                            {% with student_grade=student_grades|get_item:student.id|get_item:'grades'|get_item:grade_type.id %}
                                                <div class="input-group input-group-sm">
                                                    <input type="number" 
                                                           class="form-control grade-input" 
                                                           min="0" 
                                                           max="10" 
                                                           step="0.1" 
                                                           value="{{ student_grade.value }}"
                                                           data-student-id="{{ student.id }}"
                                                           data-grade-type-id="{{ grade_type.id }}"
                                                           data-grade-id="{{ student_grade.id|default_if_none:'' }}"
                                                           data-original-value="{{ student_grade.value }}"
                                                           data-version="1"
                                                    >
                                                </div>
                                            {% endwith %}
                                        </td>
                                    {% endfor %}
                                    <td class="average-grade">
                                        <span class="average-value" data-student-id="{{ student.id }}">-</span>
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-primary btn-save-row">
                                            <i class="fas fa-save"></i> Lưu
                                        </button>
                                        <button class="btn btn-sm btn-outline-secondary view-history" data-student-id="{{ student.id }}">
                                            <i class="fas fa-history"></i> Lịch sử
                                        </button>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>Không có sinh viên nào trong lớp này.
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Modal for grade history -->
<div class="modal fade" id="historyModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Lịch sử điểm</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="history-content">
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Đang tải...</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div>

<!-- Confirm Delete Modal -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="fas fa-trash me-2"></i>Xóa điểm</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Bạn có chắc chắn muốn xóa điểm này không?</p>
                <p>Hành động này không thể hoàn tác.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-danger" id="confirmDelete">Xóa</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function() {
        // Function to calculate average grade
        function calculateAverage(studentId) {
            let total = 0;
            let count = 0;
            let requiredCount = $('.grade-input[data-student-id="' + studentId + '"]').length; // Tổng số cột điểm cần có
            let hasAllGrades = true;
            
            // Get all grade inputs for this student
            $(`input[data-student-id="${studentId}"]`).each(function() {
                const value = $(this).val();
                if (value !== '' && value !== null) {
                    total += parseFloat(value);
                    count++;
                } else {
                    hasAllGrades = false;
                }
            });
            
            // Update average display
            const averageSpan = $(`.average-value[data-student-id="${studentId}"]`);
            if (hasAllGrades && count === requiredCount && count > 0) {
                const average = (total / count).toFixed(2);
                averageSpan.text(average);
                averageSpan.removeClass('incomplete-grades');
            } else {
                averageSpan.text('Chưa đủ điểm');
                averageSpan.addClass('incomplete-grades');
            }
        }

        // Calculate initial averages
        $('.grade-input').each(function() {
            const studentId = $(this).data('student-id');
            calculateAverage(studentId);
        });

        // Add event listener for input changes
        $('.grade-input').on('input', function() {
            const studentId = $(this).data('student-id');
            calculateAverage(studentId);
        });

        // Function to show alert in top-right corner
        function showAlert(message, type = 'success') {
            const alertContainer = $('.alert-container');
            const alert = $('<div>')
                .addClass(`alert alert-${type} alert-dismissible fade show`)
                .html(`
                    <i class="fas fa-check-circle me-2"></i>${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `);
            
            alertContainer.append(alert);
            
            // Auto dismiss after 3 seconds
            setTimeout(() => {
                alert.addClass('fade-out');
                setTimeout(() => alert.remove(), 500);
            }, 3000);
        }

        // Handle row saving
        $('.btn-save-row').click(function() {
            const row = $(this).closest('tr');
            const studentId = row.data('student-id');
            const saveBtn = $(this);
            
            // Show loading state
            saveBtn.prop('disabled', true);
            saveBtn.html('<span class="spinner-border spinner-border-sm"></span>');
            
            // Collect all grades in the row
            const grades = [];
            row.find('.grade-input').each(function() {
                const input = $(this);
                grades.push({
                    student_id: studentId,
                    grade_type_id: input.data('grade-type-id'),
                    grade_id: input.data('grade-id'),
                    value: input.val(),
                    version: input.data('version')
                });
            });
            
            // Send update request
            fetch('/update-grades/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    grades: grades
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update grade IDs and versions
                    data.grades.forEach(updatedGrade => {
                        const input = row.find(`input[data-grade-type-id="${updatedGrade.grade_type_id}"]`);
                        input.data('grade-id', updatedGrade.grade_id);
                        input.data('version', updatedGrade.version);
                    });
                    
                    // Update average
                    if (data.average !== null) {
                        $(`.average-value[data-student-id="${studentId}"]`).text(data.average);
                    }
                    
                    // Show success message
                    showAlert('Đã cập nhật điểm thành công');
                } else {
                    showAlert(data.error || 'Có lỗi xảy ra khi cập nhật điểm', 'danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('Có lỗi xảy ra khi cập nhật điểm', 'danger');
            })
            .finally(() => {
                saveBtn.prop('disabled', false);
                saveBtn.html('<i class="fas fa-save"></i> Lưu');
            });
        });
        
        // Helper function to get CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        
        // View grade history
        $('.view-history').click(function() {
            const studentId = $(this).data('student-id');
            const modal = $('#historyModal');
            
            // Show loading state in modal
            modal.find('#history-content').html(`
                <div class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Đang tải...</span>
                    </div>
                </div>
            `);
            
            modal.modal('show');
            
            // Fetch grade history
            fetch(`/grade-history/?student_id=${studentId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        modal.find('#history-content').html(data.html);
                    } else {
                        modal.find('#history-content').html(`
                            <div class="alert alert-danger">
                                ${data.error || 'Có lỗi xảy ra khi tải lịch sử điểm'}
                            </div>
                        `);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    modal.find('#history-content').html(`
                        <div class="alert alert-danger">
                            Có lỗi xảy ra khi tải lịch sử điểm
                        </div>
                    `);
            });
        });
    });
</script>
{% endblock %} 